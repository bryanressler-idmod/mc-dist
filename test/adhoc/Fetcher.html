<!doctype html>
<html>
<head>
  <title>Fetcher</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="Content-Security-Policy"
        content="default-src *;
                 font-src data: fonts.gstatic.com;
                 style-src 'self' 'unsafe-inline';
                 style-src-elem 'self' 'unsafe-inline' https://code.jquery.com https://cdn.jsdelivr.net;
                 script-src 'self' 'unsafe-eval' 'unsafe-inline' https://cdn.jsdelivr.net;
                 img-src data: 'unsafe-eval' https://www.highcharts.com;">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0-beta1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-0evHe/X+R7YkIZDRvuzKMRqM+OrBnVFBL6DOitfPri4tjfHxaWutUpFmBp4vmVor" crossorigin="anonymous">
  <script type="module" src="https://cdn.jsdelivr.net/gh/bryanressler-idmod/mc-dist@main/js/microcomps.js"></script>
  <style>
    html {
      box-sizing: border-box;
      padding: 16px;
      position: relative;
      width: 100vw;
      height: 100vh;
    }
    .content { display: none; }
    .guid {
      width: 21em;
      font-family: Consolas, Monaco, 'Andale Mono', monospace;
      font-size: 0.85em;
    }
  </style>
  <script type="module">
    import {log, logError, logInfo, logObject, setGlobalLogger, humanizeToken,
        MicroCOMPS, Simulation, BodyLogger, Auth, kSim, stopEvent,
        focusAndSelectAll, makeSpinnerSpan, spinnerUp, spinnerDown}
      from "https://cdn.jsdelivr.net/gh/bryanressler-idmod/mc-dist@main/js/microcomps.js";
    const kBaseUrl = "https://comps-dev.idmod.org";

    //==========================================================================
    // App
    //==========================================================================
    class App {
      constructor() {
        this.guidInput = document.querySelector("input.guid");
        this.entTypeSelect = document.querySelector("select.entityType");
        this.baseUrlLabel = document.querySelector("#baseUrl");
        this.tokenLabel = document.querySelector("#token");
        this.statusLabel = document.querySelector("#status");
        this.content = document.querySelector(".content");
        this.mc = null;

        setGlobalLogger(new BodyLogger());
        this.update("Starting");
      }

      //------------------------------------------------------------------------
      init() {
        let self = this;
        let token = MicroCOMPS.findToken(kBaseUrl);
        if (!token) {
          this.update(
            "Cannot start, ambient token required. The simplest solution " +
            "is to get a token from the JS console of an authenticated COMPS" +
            "session, and add the URL param token=uri-encoded-token");
        } else {
          this.mc = new MicroCOMPS({
            baseUrl: kBaseUrl,
            token: token,
            autoAuth: false,
            verbose: true,
          });

          this.update("Authenticated", token)
          logInfo("Fetcher.init: inited with token: " + humanizeToken(token));
          this.content.style.display = "block";
          //this.guidInput.addEventListener("change", evt => self.onInputEvent(evt));
          this.guidInput.addEventListener("input", evt => self.onInputEvent(evt));
          focusAndSelectAll(this.guidInput);
        }
      }

      //------------------------------------------------------------------------
      update(status, token) {
        this.baseUrlLabel.innerHTML = kBaseUrl;
        this.tokenLabel.innerHTML =
          token ? humanizeToken(token) : "None";
        this.statusLabel.innerHTML = status;
      }

      //------------------------------------------------------------------------
      fetchEntity(entityType, id) {
        // Only handling Simulations at the moment
        if (!this.mc || entityType !== kSim) {
          logError("fetchEntity: only knows about Simulations at this time.");
          return;
        }
        spinnerUp();
        this.mc.getSimulation(id)
          .then(sim => {
            spinnerDown();
            log(sim.dump());
            return Promise.resolve(sim);
          })
          .catch(errObj => {
            console.log(errObj);
            spinnerDown();
            logError("Fetcher.fetchEntity: caught an exception.");
            log(errObj.toString());
          });
      }

      //------------------------------------------------------------------------
      onInputEvent(evt) {
        stopEvent(evt);
        let guid = this.guidInput.value.trim();
        let entType = this.entTypeSelect.value;
        if (guid.length === 36)
          this.fetchEntity(entType, guid);
        else {
          this.update("Please enter a GUID in dashed format")
        }
      }
    }

    //==========================================================================
    // Fire up the app object once the DOM is loaded
    //==========================================================================
    let gApp = null;
    document.addEventListener("DOMContentLoaded", function() {
      gApp = new App();
      gApp.init();
    });
  </script>
</head>
<body>
<h1>Fetcher <span style="float: right;"><a href="../index.html"><svg width='0.75em' height='0.75em' viewBox="0 0 576 512"><path d="M288 115L69.47 307.71c-1.62 1.46-3.69 2.14-5.47 3.35V496a16 16 0 0 0 16 16h128a16 16 0 0 0 16-16V368a16 16 0 0 1 16-16h96a16 16 0 0 1 16 16v128a16 16 0 0 0 16 16h128a16 16 0 0 0 16-16V311.1c-1.7-1.16-3.72-1.82-5.26-3.2zm282.69 121.28l-255.94-226a39.85 39.85 0 0 0-53.45 0l-256 226a16 16 0 0 0-1.21 22.6L25.5 282.7a16 16 0 0 0 22.6 1.21L277.42 81.63a16 16 0 0 1 21.17 0L527.91 283.9a16 16 0 0 0 22.6-1.21l21.4-23.82a16 16 0 0 0-1.22-22.59z"/></svg></a></span></h1>
<p>This page will only run embedded in COMPS. It requires an ambient token.</p>
<p>Host: <span id="baseUrl"></span></p>
<p>Token: <span id="token">None</span></p>
<p>Status: <span id="status">Starting</span></p>
<div class="content">
  <hr>
  <select class="entityType" value="Simulations">
    <option value="Simulations">Simulation</option>
    <option value="Experiments">Experiment</option>
    <option value="Suites">Suite</option>
    <option value="AssetCollections">Asset Collection</option>
    <option value="WorkItems">Work Item</option>
  </select>
  <label>ID:&nbsp;&nbsp;<input type="text" class="guid" tabindex=0 value="c44adb92-57fd-ec11-92ec-f0921c167860" placeholder="xxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx"></label>
  <pre class="output"></pre>
</div>
</body>
